name: Move issue to correct status on commit

on:
  push:
    branches:
      - '**'

jobs:
  move-issue:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Extract issue references
        id: extract_issues
        uses: actions/github-script@v6
        with:
          script: |
            const commitMessage = process.env.COMMIT_MESSAGE;
            
            // Extraire les références d'issues
            const refs = [...commitMessage.matchAll(/refs\s*#(\d+)/g)]
              .map(m => ({number: parseInt(m[1]), action: 'in_progress'}));
            
            // Extraire les fermetures d'issues
            const closes = [...commitMessage.matchAll(/(closes|closed|fixes|fixed)\s*#(\d+)/g)]
              .map(m => ({number: parseInt(m[2]), action: 'done'}));
            
            // Fusionner et supprimer les doublons
            const allIssues = [...refs, ...closes].reduce((acc, issue) => {
              // Garde la dernière action pour chaque numéro d'issue
              acc[issue.number] = issue;
              return acc;
            }, {});
            
            const issues = Object.values(allIssues);
            console.log('Issues found:', issues);
            
            return issues;
          result-encoding: json
        env:
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
