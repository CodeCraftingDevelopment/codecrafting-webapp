name: Move issue to correct status on commit

on:
  push:
    branches:
      - '**'

permissions:
  contents: write
  packages: write

jobs:

  search-project:
    name: Recherche du projet
    runs-on: ubuntu-latest
    outputs:
      project: ${{ steps.set-outputs.outputs.project }}
    steps:
      - name: Installer GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y

      - uses: actions/checkout@v3

      - name: Find project from commit
        id: extract_project
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
            # Afficher les variables d'environnement pour le débogage
            echo "Repository: ${{ github.repository_owner }}/${{ github.event.repository.name }}"
            
            # Exécuter la requête avec sortie brute pour le débogage
            echo "Exécution de la requête GraphQL..."
            RESPONSE=$(gh api graphql -f query='
            query {
            repository(owner: "'${{ github.repository_owner }}'", name: "'${{ github.event.repository.name }}'") {
                                                                          projectsV2(first: 1) {
                                                                            nodes {
                                                                            id
                                                                            }
            }
          }
          }')
            
            # Afficher la réponse brute
            echo "Réponse de l'API:"
            echo "$RESPONSE"
            
            # Extraire l'ID du projet
            PROJECT_ID=$(echo "$RESPONSE" | jq -r '.data.repository.projectsV2.nodes[0].id // empty')
            
            if [ -z "$PROJECT_ID" ]; then
            echo "Aucun projet V2 trouvé ou erreur lors de la récupération"
            # Vérifier les permissions
            echo "Vérification des permissions..."
            gh api -H "Authorization: token $GH_TOKEN" /user -i
            else
            echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
            echo "ID du projet trouvé: $PROJECT_ID"
            fi


  check-commit:
    name: Vérification des commits
    runs-on: ubuntu-latest
    outputs:
      ref_issues: ${{ steps.set-outputs.outputs.ref_issues }}
      closed_issues: ${{ steps.set-outputs.outputs.closed_issues }}
    steps:
      - uses: actions/checkout@v3

      - name: Extract issue references
        id: extract_refs
        run: |
          # Récupérer le message du commit
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          
          # Extraire les références d'issues (format: refs #123)
          REF_ISSUES=$(echo "$COMMIT_MSG" | grep -oP 'refs\s*#\K\d+' | tr '\n' ' ')
          
          # Extraire les fermetures d'issues (format: closes #123, fixed #456)
          CLOSED_ISSUES=$(echo "$COMMIT_MSG" | grep -oP '(?:closes|closed|fixes|fixed)\s*#\K\d+' | tr '\n' ' ')
          
          # Fusionner et trier les numéros uniques
          ALL_ISSUES=$(echo -e "$REF_ISSUES\n$CLOSED_ISSUES" | sort -n | uniq | tr '\n' ' ')
          
          # Afficher les résultats
          echo "Issues référencées: $REF_ISSUES"
          echo "Issues fermées: $CLOSED_ISSUES"
          echo "Toutes les issues uniques: $ALL_ISSUES"
          
          # Définir les sorties
          echo "ref_issues=$REF_ISSUES" >> $GITHUB_OUTPUT
          echo "closed_issues=$CLOSED_ISSUES" >> $GITHUB_OUTPUT
          echo "all_issues=$ALL_ISSUES" >> $GITHUB_OUTPUT
          

        
